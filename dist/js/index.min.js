import{products,citiesAndDepartments}from"./data.min.js";import{hideElement,showElement,getBackImg,getParameterList,resetQuantity,resetTextInput,setSum,validateName,validatePhone,validateEmail,validateCity,validateDepartment,showError,submitForm,formatDate,formatTime,toggleCategories,renderOrderDetails}from"./helpers.min.js";const prodCat=document.querySelector(".aside .productCategories"),prodList=document.querySelector(".section.main .productList"),prodDesc=document.querySelector(".section.side .productDescription"),myOrders=document.getElementById("myOrders"),popupWrapper=document.querySelector(".popupWrapper"),popupForm=document.querySelector(".popupWrapper .form.popup"),popupCloseBtn=document.querySelector(".popupWrapper .form .closeBtn"),productQuantity=document.querySelector(".popupWrapper .form #quantity"),customerWishes=document.querySelector("#wishes"),nameField=document.querySelector(".form .name"),phoneField=(nameField.addEventListener("change",()=>validateName(nameField.value,".form .name + .error")),document.querySelector(".form .tel")),emailField=(phoneField.addEventListener("change",()=>validatePhone(phoneField.value,".form .tel + .error")),document.querySelector(".form .email")),cityField=(emailField.addEventListener("change",()=>validateEmail(emailField.value,".form .email + .error")),document.querySelector(".form .city")),departmentField=(cityField.addEventListener("change",()=>validateCity(cityField.value,".form .city + .error")),document.querySelector(".form .department"));departmentField.addEventListener("change",()=>validateDepartment(departmentField.value,".form .department + .error"));let activeItem;function showProducts(t){activeItem!==t.target&&(prodList.innerHTML="",prodDesc.innerHTML="",swapActiveItem(t.target),products.filter(e=>e.categories===t.target.id).forEach(e=>{var t=document.createElement("div");t.className="productCard",t.id=e.id,t.innerHTML=`
        <img src="${e.img}" alt="">
        <h4>${e.name}</h4>
        <p class="price">${e.price} ₴</p>`,prodList.append(t)}))}function showDesc(e){const t=e.target.closest(".productCard");t&&(prodDesc.innerHTML="",e=products.find(e=>e.id===t.id),prodDesc.innerHTML=`
     <img src='${getBackImg(e.img)}' class='bigImg'>
     <h3 class='title h3'>${e.name}</h3>
     <ul class='params'>${getParameterList(e.parameters)}</ul>
     <p class='price'>${e.price} ₴</p>
    <button type='button' class='btn big main buyBtn' id='${t.id}'>Buy</button>`,resetQuantity(productQuantity),resetTextInput(customerWishes),document.querySelector(".buyBtn").addEventListener("click",openOrderForm))}function openOrderForm(){showElement(popupWrapper),showElement(popupForm);const t=document.querySelector(".form .field .select.city"),r=document.querySelector(".form .field .select.department");t.innerHTML='<option value="" selected disabled>Your City</option>',r.innerHTML='<option value="" selected disabled>Nova Post Department</option>',citiesAndDepartments.forEach(e=>{t.innerHTML+=`
        <option value="${e.city}">${e.city}</option>`}),t.addEventListener("change",()=>{r.innerHTML='<option value="" selected disabled>Nova Post Department</option>',citiesAndDepartments.filter(e=>e.city===t.value)[0].departments.forEach(e=>{r.innerHTML+=`
            <option value="${e.number}">"${e.number}" – ${e.address}</option>`})}),document.querySelector(".form .submit").addEventListener("click",validateForm)}function checkQuantity(){productQuantity.value<1?productQuantity.value=1:99<productQuantity.value&&(productQuantity.value=99),productQuantity.value=Math.floor(productQuantity.value),setSum(productQuantity.value)}function validateForm(e){e.preventDefault();var e=document.querySelector(".buyBtn").id,t=[];t.push(validateName(nameField.value,".form .name + .error")),t.push(validatePhone(phoneField.value,".form .tel + .error")),t.push(validateEmail(emailField.value,".form .email + .error")),t.push(validateCity(cityField.value,".form .city + .error")),t.push(validateDepartment(departmentField.value,".form .department + .error")),t.includes(0)||buyProduct(e)}function closeOrderForm(e){e.currentTarget===e.target&&(hideElement(popupWrapper),hideElement(popupForm))}function buyProduct(t){let e=JSON.parse(localStorage.getItem("orders")),r=(e=e||[],+localStorage.getItem("currentOrderID"));r||(localStorage.setItem("currentOrderID",1),r=+localStorage.getItem("currentOrderID"));var o=products.find(e=>e.id===t).price,a=new Date;const i={date:formatDate(a),time:formatTime(a),productID:t,orderID:r,quantity:+productQuantity.value,price:o,customer_name:nameField.value,customer_phone:phoneField.value,customer_email:emailField.value,customer_city:cityField.value,customer_department:departmentField.value,customer_paymentMethod:document.querySelector("#payment input:checked").value,customer_wishes:customerWishes.value};e.push(i),localStorage.setItem("orders",JSON.stringify(e)),localStorage.setItem("currentOrderID",+r+1),submitForm(i),hideElement(popupWrapper),hideElement(popupForm),clearAll();a=products.find(e=>e.id===i.productID);renderOrderDetails(prodList,i,a,!1)}function clearAll(){activeItem="",prodDesc.innerHTML="",prodList.innerHTML="";var e=document.getElementById("orderList"),e=(e&&e.remove(),document.querySelector(".aside .productCategories .active"));e&&e.classList.remove("active")}prodCat.addEventListener("click",showProducts),prodList.addEventListener("click",showDesc),productQuantity.addEventListener("change",checkQuantity),popupWrapper.addEventListener("mousedown",closeOrderForm),popupCloseBtn.addEventListener("click",closeOrderForm),myOrders.addEventListener("click",()=>{toggleMyOrders(!0)});let myOrdersActive=!1;const myOrdersStatus=["My orders","Categories"];function toggleMyOrders(e){var t=JSON.parse(localStorage.getItem("orders"));if(t&&(clearAll(),activeItem="",e&&(toggleCategories(myOrdersStatus[+myOrdersActive],".aside .productCategories"),myOrdersActive=!myOrdersActive,myOrders.innerText=myOrdersStatus[+myOrdersActive]),myOrdersActive)){e=document.querySelector(".aside");const r=document.createElement("ul");r.id="orderList",t.reverse().forEach(e=>{r.innerHTML+=`<li id='${e.orderID}'>
        <p class='date txt'>${e.date}</p>
        <p class='price txt'>${e.price} ₴</p>
        <span class='quantitySpan'>x${e.quantity}</span>
        </li>`}),e.append(r),r.addEventListener("click",showOrderDetails)}}function showOrderDetails(e){const t=e.target.closest("li");if(t){swapActiveItem(t);const r=JSON.parse(localStorage.getItem("orders")).find(e=>e.orderID===+t.id);e=products.find(e=>e.id===r.productID);renderOrderDetails(prodList,r,e,!0),document.querySelector(".orderDetails .del").addEventListener("click",deleteOrder)}}function swapActiveItem(e){activeItem&&activeItem.classList.remove("active"),(activeItem=e).classList.add("active")}function deleteOrder(e){var t=JSON.parse(localStorage.getItem("orders"));const r=e.target.id.split("_")[1];e=t.filter(e=>e.orderID!==+r);0<e.length?(localStorage.setItem("orders",JSON.stringify(e)),toggleMyOrders(!1)):(localStorage.removeItem("orders"),toggleCategories("Categories",".aside .productCategories"),myOrders.innerText="My orders",clearAll())}